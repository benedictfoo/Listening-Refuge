---
// src/pages/tags/[tag]/index.astro

import {getCollection} from 'astro:content';
import PostGridLayout from '../../../layouts/PostGridLayout.astro';
import PaginationButtons from '../../../components/PaginationButtons.astro';
import BaseLayout from "../../../layouts/BaseLayout.astro";
import {POSTS_PER_PAGE} from "../../../consts";

export async function getStaticPaths() {
    const all = await getCollection('blog');
    const tags = Array.from(new Set(all.flatMap(p => p.data.tags)));
    return tags.map(tag => ({params: {tag}}));
}


const {tag} = Astro.params;

const all = await getCollection('blog');
const filtered = all
    .filter(p => p.data.tags.includes(tag))
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const page1 = filtered.slice(0, POSTS_PER_PAGE);
const totalPages = Math.ceil(filtered.length / POSTS_PER_PAGE);
const title = `Posts tagged: ${tag}`
const description = `Find relevant posts on a topic here`
---

<BaseLayout title={title} description={description}>


    <PostGridLayout posts={page1} title={title}/>
    {totalPages > 1 && (
            <PaginationButtons
                    currPage={1}
                    lastPage={totalPages}
                    baseHref={`/tags/${tag}`}
            />
    )}
</BaseLayout>
